<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Manage Hooks - TabletopTeacher</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .hook-editor {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .hook-category {
            margin-bottom: 24px;
        }
        .hook-list {
            list-style: none;
            padding: 0;
            margin: 12px 0;
        }
        .hook-item {
            display: flex;
            gap: 8px;
            margin: 8px 0;
            padding: 8px;
            background: #f8f8f8;
            border-radius: 4px;
            align-items: center;
        }
        .hook-text {
            flex: 1;
            margin: 0;
        }
        .custom-hook {
            background: #fff3e0;
        }
        .hook-actions {
            display: flex;
            gap: 8px;
        }
        .add-hook-form {
            display: flex;
            gap: 8px;
            margin: 16px 0;
            padding: 16px;
            background: #f0f0f0;
            border-radius: 4px;
        }
        .add-hook-form input[type="text"] {
            flex: 1;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .add-hook-form select {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            background: #974a4a;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background: #873a3a;
        }
        button.delete {
            background: #c62828;
        }
        button.delete:hover {
            background: #b71c1c;
        }
        .nav-links {
            margin: 20px 0;
        }
        .nav-links a {
            color: #974a4a;
            text-decoration: none;
            margin-right: 16px;
        }
        .nav-links a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="hook-editor">
        <div class="nav-links">
            <a href="../index.html">‚Üê Home</a>
            <a href="../generator.html">Session Generator</a>
        </div>
        <h1>Manage Story Hooks</h1>
        
        <div class="add-hook-form">
            <select id="newHookCategory">
                <option value="urban">Urban</option>
                <option value="forest">Forest</option>
                <option value="dungeon">Dungeon</option>
            </select>
            <input type="text" id="newHookText" placeholder="Enter a new hook (ends with 'in' or 'of' for location)">
            <button onclick="addHook()">Add Hook</button>
        </div>

        <div id="hookCategories">
            <!-- Hooks will be loaded here -->
        </div>
    </div>

    <script>
        // Load and render hooks
        async function loadHooks() {
            try {
                const response = await fetch('hooks.json');
                const data = await response.json();
                renderHooks(data);
            } catch (err) {
                console.error('Failed to load hooks:', err);
            }
        }

        function renderHooks(data) {
            const container = document.getElementById('hookCategories');
            container.innerHTML = '';

            const categories = ['urban', 'forest', 'dungeon'];
            categories.forEach(category => {
                const div = document.createElement('div');
                div.className = 'hook-category';
                div.innerHTML = `
                    <h2>${category.charAt(0).toUpperCase() + category.slice(1)} Hooks</h2>
                    <ul class="hook-list" data-category="${category}">
                        ${renderHookList(data.hooks[category] || [], data.custom_hooks[category] || [], category)}
                    </ul>
                `;
                container.appendChild(div);
            });
        }

        function renderHookList(defaultHooks, customHooks, category) {
            let html = '';
            // Default hooks (read-only)
            defaultHooks.forEach(hook => {
                html += `
                <li class="hook-item">
                    <p class="hook-text">${hook}</p>
                </li>`;
            });
            // Custom hooks (editable)
            customHooks.forEach(hook => {
                html += `
                <li class="hook-item custom-hook">
                    <p class="hook-text">${hook}</p>
                    <div class="hook-actions">
                        <button class="delete" onclick="deleteHook('${category}', '${hook.replace(/'/g, "\\'")}')">Delete</button>
                    </div>
                </li>`;
            });
            return html;
        }

        async function addHook() {
            const category = document.getElementById('newHookCategory').value;
            let text = document.getElementById('newHookText').value.trim();
            
            if (!text) {
                alert('Please enter hook text');
                return;
            }

            // Ensure hook ends with "in" or "of" for location
            if (!text.endsWith(' in') && !text.endsWith(' of')) {
                text += ' in';
            }

            try {
                const response = await fetch('hooks.json');
                const data = await response.json();
                
                // Initialize custom_hooks category if needed
                if (!data.custom_hooks[category]) {
                    data.custom_hooks[category] = [];
                }
                
                // Add new hook if it doesn't exist
                if (!data.custom_hooks[category].includes(text) && !data.hooks[category].includes(text)) {
                    data.custom_hooks[category].push(text);
                    
                    // Save back to server
                    await saveHooks(data);
                    
                    // Refresh display
                    renderHooks(data);
                    document.getElementById('newHookText').value = '';
                } else {
                    alert('This hook already exists!');
                }
            } catch (err) {
                console.error('Failed to add hook:', err);
                alert('Failed to add hook. Please try again.');
            }
        }

        async function deleteHook(category, hook) {
            if (!confirm('Are you sure you want to delete this hook?')) return;

            try {
                const response = await fetch('hooks.json');
                const data = await response.json();
                
                // Remove hook from custom_hooks
                if (data.custom_hooks[category]) {
                    data.custom_hooks[category] = data.custom_hooks[category].filter(h => h !== hook);
                }
                
                // Save back to server
                await saveHooks(data);
                
                // Refresh display
                renderHooks(data);
            } catch (err) {
                console.error('Failed to delete hook:', err);
                alert('Failed to delete hook. Please try again.');
            }
        }

        async function saveHooks(data) {
            try {
                const response = await fetch('http://localhost:3000/hooks', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                if (!response.ok) throw new Error('Failed to save hooks');
                const result = await response.json();
                if (!result.success) throw new Error(result.message || 'Save failed');
            } catch (err) {
                console.error('Failed to save hooks:', err);
                throw err;
            }
        }

        // Initialize
        loadHooks();
    </script>
</body>
</html>